<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uganda Malaria Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Replace Chart.js with Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .tab {
            overflow: hidden;
            background-color: #333;
        }
        .tab button {
            background-color: inherit;
            color: white;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab button:hover {
            background-color: #555;
        }
        .tab button.active {
            background-color: #007bff;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            background-color: white;
            margin: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .district-marker {
            animation: glow 2s infinite alternate;
        }
        .high-glow {
            animation: high-glow 2s infinite alternate, flicker 0.3s infinite alternate;
        }
        .medium-glow {
            animation: medium-glow 2s infinite alternate, flicker 0.3s infinite alternate;
        }
        .low-glow {
            animation: low-glow 2s infinite alternate;
        }
        @keyframes high-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(255, 0, 0, 0.7), 0 0 15px rgba(255, 0, 0, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(255, 0, 0, 0.9), 0 0 30px rgba(255, 0, 0, 0.9); }
        }
        @keyframes medium-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(255, 165, 0, 0.7), 0 0 15px rgba(255, 165, 0, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(255, 165, 0, 0.9), 0 0 30px rgba(255, 165, 0, 0.9); }
        }
        @keyframes low-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(0, 255, 0, 0.7), 0 0 15px rgba(0, 255, 0, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(0, 255, 0, 0.9), 0 0 30px rgba(0, 255, 0, 0.9); }
        }
        @keyframes flicker {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }
        .marker-circle {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            border: 2px solid white;
            position: relative;
        }
        .filter-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .filter-controls select {
            padding: 5px;
            font-size: 14px;
        }
        .map-and-chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        #map {
            flex: 2;
            min-width: 300px;
            height: 500px;
        }
        .chart-container {
            flex: 1;
            min-width: 300px;
            height: 500px;
        }
        /* New style for Plotly chart */
        .plotly-chart {
            width: 100%;
            height: 100%;
            background: transparent;
        }
        @media (max-width: 768px) {
            .map-and-chart-container {
                flex-direction: column;
            }
            #map, .chart-container {
                width: 100%;
                height: 400px;
            }
            .tab button { padding: 10px 12px; font-size: 14px; }
            .filter-controls { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Uganda Malaria Dashboard</h1>
    </div>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Overview')" id="defaultOpen">Overview</button>
        <button class="tablinks" onclick="openTab(event, 'Trends')">Trends</button>
        <button class="tablinks" onclick="openTab(event, 'Map')">Malaria Map</button>
    </div>

    <div id="Overview" class="tabcontent">
        <h2>Overview</h2>
        <p>Welcome to the Uganda Malaria Dashboard. This section provides a summary of malaria cases across the country for April to June 2025.</p>
    </div>

    <div id="Trends" class="tabcontent">
        <h2>Trends</h2>
        <p>View trends in malaria cases over time.</p>
    </div>

    <div id="Map" class="tabcontent">
        <h2>Malaria Cases Map</h2>
        <div class="filter-controls">
            <div>
                <label for="monthFilter">Select Month: </label>
                <select id="monthFilter" onchange="updateMap()">
                    <option value="April">April 2025</option>
                    <option value="May">May 2025</option>
                    <option value="June">June 2025</option>
                </select>
            </div>
            <div>
                <label for="statusFilter">Filter by Status: </label>
                <select id="statusFilter" onchange="filterMarkers()">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>
        <div class="map-and-chart-container">
            <div id="map"></div>
            <div class="chart-container">
                <div id="statusTrendChart" class="plotly-chart"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const districts = [
            {"district": "Abim", "latitude": 2.7032, "longitude": 33.6732},
            {"district": "Adjumani", "latitude": 3.3869, "longitude": 31.7909},
            {"district": "Agago", "latitude": 2.8394, "longitude": 33.3486},
            {"district": "Alebtong", "latitude": 2.2540, "longitude": 33.3486},
            {"district": "Amolatar", "latitude": 1.6346, "longitude": 32.8286},
            {"district": "Amudat", "latitude": 1.9500, "longitude": 34.9500},
            {"district": "Amuria", "latitude": 2.0150, "longitude": 33.6422},
            {"district": "Amuru", "latitude": 2.9500, "longitude": 32.0500},
            {"district": "Apac", "latitude": 1.9847, "longitude": 32.5385},
            {"district": "Arua", "latitude": 3.0191, "longitude": 30.9110},
            {"district": "Budaka", "latitude": 1.0833, "longitude": 33.9333},
            {"district": "Bududa", "latitude": 1.0000, "longitude": 34.3333},
            {"district": "Bugiri", "latitude": 0.5714, "longitude": 33.7412},
            {"district": "Bugweri", "latitude": 0.5785, "longitude": 33.5378},
            {"district": "Buhweju", "latitude": -0.3142, "longitude": 30.3717},
            {"district": "Buikwe", "latitude": 0.3292, "longitude": 33.0806},
            {"district": "Bukedea", "latitude": 1.3500, "longitude": 34.0500},
            {"district": "Bukomansimbi", "latitude": -0.1500, "longitude": 31.6500},
            {"district": "Bukwo", "latitude": 1.2925, "longitude": 34.7425},
            {"district": "Bulambuli", "latitude": 1.3750, "longitude": 34.1667},
            {"district": "Buliisa", "latitude": 2.0833, "longitude": 31.4167},
            {"district": "Bundibugyo", "latitude": 0.7306, "longitude": 30.0419},
            {"district": "Bunyangabu", "latitude": 0.5000, "longitude": 30.1667},
            {"district": "Busia", "latitude": 0.4600, "longitude": 34.1000},
            {"district": "Butaleja", "latitude": 0.9419, "longitude": 33.9556},
            {"district": "Butambala", "latitude": 0.1711, "longitude": 32.1044},
            {"district": "Butebo", "latitude": 1.2346, "longitude": 33.9087},
            {"district": "Buvuma", "latitude": 0.2440, "longitude": 33.2364},
            {"district": "Buyende", "latitude": 1.2739, "longitude": 33.5158},
            {"district": "Dokolo", "latitude": 1.9167, "longitude": 33.1667},
            {"district": "Gulu", "latitude": 2.7746, "longitude": 32.2980},
            {"district": "Hoima", "latitude": 1.4356, "longitude": 31.3520},
            {"district": "Ibanda", "latitude": -0.1191, "longitude": 30.4994},
            {"district": "Iganga", "latitude": 0.6092, "longitude": 33.4686},
            {"district": "Isingiro", "latitude": -0.8194, "longitude": 30.8039},
            {"district": "Jinja", "latitude": 0.4242, "longitude": 33.2047},
            {"district": "Kabale", "latitude": -1.2486, "longitude": 29.9920},
            {"district": "Kabarole", "latitude": 0.6667, "longitude": 30.2750},
            {"district": "Kaberamaido", "latitude": 1.7667, "longitude": 33.1500},
            {"district": "Kagadi", "latitude": 0.9397, "longitude": 30.7987},
            {"district": "Kakumiro", "latitude": 0.7803, "longitude": 31.3244},
            {"district": "Kalangala", "latitude": -0.3073, "longitude": 32.2250},
            {"district": "Kaliro", "latitude": 0.8945, "longitude": 33.4789},
            {"district": "Kalungu", "latitude": -0.2100, "longitude": 31.7650},
            {"district": "Kampala", "latitude": 0.3136, "longitude": 32.5811},
            {"district": "Kamuli", "latitude": 0.9472, "longitude": 33.1197},
            {"district": "Kamwenge", "latitude": 0.1900, "longitude": 30.4533},
            {"district": "Kanungu", "latitude": -0.9500, "longitude": 29.7500},
            {"district": "Kapchorwa", "latitude": 1.4000, "longitude": 34.4500},
            {"district": "Kasese", "latitude": 0.1833, "longitude": 30.0833},
            {"district": "Katakwi", "latitude": 1.9167, "longitude": 34.0000},
            {"district": "Kayunga", "latitude": 0.7025, "longitude": 32.8886},
            {"district": "Kibaale", "latitude": 0.8000, "longitude": 31.0833},
            {"district": "Kiboga", "latitude": 0.9167, "longitude": 31.7667},
            {"district": "Kibuku", "latitude": 1.0623, "longitude": 33.8500},
            {"district": "Kiruhura", "latitude": -0.2000, "longitude": 30.8000},
            {"district": "Kiryandongo", "latitude": 1.9167, "longitude": 32.0833},
            {"district": "Kisoro", "latitude": -1.2833, "longitude": 29.6833},
            {"district": "Kitgum", "latitude": 3.2783, "longitude": 32.8867},
            {"district": "Koboko", "latitude": 3.4106, "longitude": 30.9600},
            {"district": "Kole", "latitude": 2.4333, "longitude": 32.8000},
            {"district": "Kotido", "latitude": 3.0333, "longitude": 34.1167},
            {"district": "Kumi", "latitude": 1.4856, "longitude": 33.9361},
            {"district": "Kwania", "latitude": 2.1492, "longitude": 32.7092},
            {"district": "Kween", "latitude": 1.4286, "longitude": 34.5439},
            {"district": "Kyankwanzi", "latitude": 1.2000, "longitude": 31.8000},
            {"district": "Kyegegwa", "latitude": 0.5000, "longitude": 31.0417},
            {"district": "Kyenjojo", "latitude": 0.6111, "longitude": 30.6350},
            {"district": "Lamwo", "latitude": 3.5317, "longitude": 32.8039},
            {"district": "Lira", "latitude": 2.2481, "longitude": 32.8998},
            {"district": "Luuka", "latitude": 0.7652, "longitude": 33.3024},
            {"district": "Luwero", "latitude": 0.8333, "longitude": 32.5000},
            {"district": "Lwengo", "latitude": -0.4167, "longitude": 31.4167},
            {"district": "Lyantonde", "latitude": -0.4033, "longitude": 31.1575},
            {"district": "Manafwa", "latitude": 0.9333, "longitude": 34.2833},
            {"district": "Maracha", "latitude": 3.2878, "longitude": 30.9403},
            {"district": "Masaka", "latitude": -0.3333, "longitude": 31.7167},
            {"district": "Masindi", "latitude": 1.6833, "longitude": 31.7167},
            {"district": "Mayuge", "latitude": 0.4500, "longitude": 33.4833},
            {"district": "Mbale", "latitude": 1.0806, "longitude": 34.1750},
            {"district": "Mbarara", "latitude": -0.6057, "longitude": 30.6485},
            {"district": "Mitooma", "latitude": -0.6094, "longitude": 30.0036},
            {"district": "Mityana", "latitude": 0.4170, "longitude": 32.0423},
            {"district": "Moroto", "latitude": 2.5387, "longitude": 34.6666},
            {"district": "Moyo", "latitude": 3.6600, "longitude": 31.7300},
            {"district": "Mpigi", "latitude": 0.2250, "longitude": 32.3136},
            {"district": "Mubende", "latitude": 0.5578, "longitude": 31.3956},
            {"district": "Mukono", "latitude": 0.3533, "longitude": 32.7553},
            {"district": "Nakapiripirit", "latitude": 1.8500, "longitude": 34.7167},
            {"district": "Nakaseke", "latitude": 0.9531, "longitude": 32.0833},
            {"district": "Nakasongola", "latitude": 1.3167, "longitude": 32.4500},
            {"district": "Namayingo", "latitude": 0.2353, "longitude": 33.8667},
            {"district": "Namisindwa", "latitude": 0.9124, "longitude": 34.3904},
            {"district": "Namutumba", "latitude": 0.8500, "longitude": 33.6833},
            {"district": "Napak", "latitude": 2.5233, "longitude": 34.2442},
            {"district": "Nebbi", "latitude": 2.4650, "longitude": 31.0886},
            {"district": "Ngora", "latitude": 1.4600, "longitude": 33.7772},
            {"district": "Ntoroko", "latitude": 1.0364, "longitude": 30.5316},
            {"district": "Ntungamo", "latitude": -0.8833, "longitude": 30.2667},
            {"district": "Nwoya", "latitude": 2.6300, "longitude": 32.0000},
            {"district": "Omoro", "latitude": 2.7100, "longitude": 32.6000},
            {"district": "Otuke", "latitude": 2.5167, "longitude": 33.5000},
            {"district": "Oyam", "latitude": 2.2781, "longitude": 32.4461},
            {"district": "Pader", "latitude": 2.8667, "longitude": 33.1667},
            {"district": "Pakwach", "latitude": 2.4722, "longitude": 31.4944},
            {"district": "Pallisa", "latitude": 1.1667, "longitude": 33.7167},
            {"district": "Rubanda", "latitude": -1.1833, "longitude": 29.8000},
            {"district": "Rubirizi", "latitude": -0.2667, "longitude": 30.1000},
            {"district": "Rukiga", "latitude": -1.1528, "longitude": 30.0067},
            {"district": "Rukungiri", "latitude": -0.8411, "longitude": 29.9278},
            {"district": "Sembabule", "latitude": -0.0775, "longitude": 31.4592},
            {"district": "Serere", "latitude": 1.5000, "longitude": 33.5667},
            {"district": "Sheema", "latitude": -0.5727, "longitude": 30.3786},
            {"district": "Sironko", "latitude": 1.2300, "longitude": 34.2500},
            {"district": "Soroti", "latitude": 1.7167, "longitude": 33.6167},
            {"district": "Tororo", "latitude": 0.6922, "longitude": 34.1800},
            {"district": "Wakiso", "latitude": 0.4057, "longitude": 32.4780},
            {"district": "Yumbe", "latitude": 3.4650, "longitude": 31.2481},
            {"district": "Zombo", "latitude": 2.5333, "longitude": 30.9167}
        ];

        function generateMalariaData() {
            const threshold = 750;
            return districts.map(district => {
                const casesApril = Math.floor(Math.random() * 1000) + 100;
                const casesMay = Math.floor(Math.random() * 1000) + 100;
                const casesJune = Math.floor(Math.random() * 1000) + 100;

                const getStatus = (cases) => {
                    if (cases > threshold) return 'high';
                    else if (cases > threshold * 0.7) return 'medium';
                    else return 'low';
                };

                return {
                    ...district,
                    cases: {
                        April: casesApril,
                        May: casesMay,
                        June: casesJune
                    },
                    status: {
                        April: getStatus(casesApril),
                        May: getStatus(casesMay),
                        June: getStatus(casesJune)
                    }
                };
            });
        }

        const malariaData = generateMalariaData();
        let map, districtsLayer;
        let currentMonth = 'April';
        let statusTrendChart = null;

        function initMap() {
            if (map) return;

            map = L.map('map').setView([1.3733, 32.2903], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            districtsLayer = L.layerGroup().addTo(map);
            updateMap();

            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'info legend');
                const statuses = ['high', 'medium', 'low'];
                const colors = ['red', 'orange', 'green'];
                const labels = ['Above threshold (Flickering)', 'Within 30% of threshold (Flickering)', 'Below threshold'];

                div.innerHTML = '<h4>Malaria Cases Status</h4>';
                for (let i = 0; i < statuses.length; i++) {
                    div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + labels[i] + '<br>';
                }
                return div;
            };
            legend.addTo(map);

            const info = L.control({position: 'topright'});
            info.onAdd = function() {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };
            info.update = function(props) {
                this._div.innerHTML = '<h4>Uganda Malaria Cases</h4>' + 
                    (props ? 
                        `<b>${props.district}</b><br>Cases in ${currentMonth} 2025: ${props.cases[currentMonth]}` : 
                        `Click on a district for details<br>Data for ${currentMonth} 2025`);
            };
            info.addTo(map);
        }

        function updateMap() {
            currentMonth = document.getElementById('monthFilter').value;
            districtsLayer.clearLayers();

            function getColor(status) {
                return status === 'high' ? 'red' :
                       status === 'medium' ? 'orange' : 'green';
            }

            function getGlowClass(status) {
                return status === 'high' ? 'high-glow' :
                       status === 'medium' ? 'medium-glow' : 'low-glow';
            }

            malariaData.forEach(data => {
                const currentCases = data.cases[currentMonth];
                const currentStatus = data.status[currentMonth];

                const icon = L.divIcon({
                    className: `district-marker ${getGlowClass(currentStatus)}`,
                    html: `<div class="marker-circle" style="background-color: ${getColor(currentStatus)}"></div>`,
                    iconSize: [13, 13],
                    iconAnchor: [7, 7]
                });

                const marker = L.marker([data.latitude, data.longitude], {
                    icon: icon,
                    riseOnHover: true,
                    data: data
                });

                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <b>${data.district}</b><br>
                        Malaria Cases in ${currentMonth} 2025: <strong>${currentCases}</strong><br>
                        Status: <span style="color: ${getColor(currentStatus)}">${currentStatus}</span>
                        <div style="margin-top: 5px; height: 5px; width: 100%; 
                             background: linear-gradient(to right, #4CAF50 0%, #FFC107 50%, #F44336 100%); 
                             background-position: ${100 - (currentCases / 10)}% 0;
                             border-radius: 3px;"></div>
                    </div>
                `);

                marker.bindTooltip(
                    `${data.district}: ${currentCases} cases (${currentMonth} 2025)`,
                    { direction: 'top', offset: [0, -10] }
                );

                marker.addTo(districtsLayer);
            });

            const infoControl = map._controlContainer.querySelector('.info');
            if (infoControl) {
                infoControl.innerHTML = `<h4>Uganda Malaria Cases</h4>Click on a district for details<br>Data for ${currentMonth} 2025`;
            }

            filterMarkers();
            renderStatusTrendChart();
        }

        function filterMarkers() {
            const filterValue = document.getElementById('statusFilter').value;
            districtsLayer.eachLayer(layer => {
                const markerData = layer.options.data;
                const currentStatus = markerData.status[currentMonth];
                const shouldShow = filterValue === 'all' || currentStatus === filterValue;
                layer.setOpacity(shouldShow ? 1 : 0);
                layer.getElement().style.display = shouldShow ? 'block' : 'none';
            });
        }

        function renderStatusTrendChart() {
            const months = ['April', 'May', 'June'];
            const counts = {
                high: months.map(month => malariaData.filter(d => d.status[month] === 'high').length),
                medium: months.map(month => malariaData.filter(d => d.status[month] === 'medium').length),
                low: months.map(month => malariaData.filter(d => d.status[month] === 'low').length)
            };

            const highTrace = {
                x: months.map(m => `${m} 2025`),
                y: counts.high,
                name: 'High',
                mode: 'lines+markers',
                line: {
                    color: '#EF553B',
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    size: 8,
                    color: '#EF553B'
                }
            };

            const mediumTrace = {
                x: months.map(m => `${m} 2025`),
                y: counts.medium,
                name: 'Medium',
                mode: 'lines+markers',
                line: {
                    color: '#FFA15A',
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    size: 8,
                    color: '#FFA15A'
                }
            };

            const lowTrace = {
                x: months.map(m => `${m} 2025`),
                y: counts.low,
                name: 'Low',
                mode: 'lines+markers',
                line: {
                    color: '#00CC96',
                    width: 3,
                    shape: 'spline'
                },
                marker: {
                    size: 8,
                    color: '#00CC96'
                }
            };

            const layout = {
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    family: 'Arial, sans-serif',
                    size: 12,
                    color: '#333'
                },
                margin: {
                    l: 50,
                    r: 30,
                    b: 50,
                    t: 50,
                    pad: 10
                },
                xaxis: {
                    showgrid: false,
                    linecolor: '#999',
                    linewidth: 1,
                    mirror: true,
                    tickfont: {
                        size: 11
                    }
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#eee',
                    linecolor: '#999',
                    linewidth: 1,
                    mirror: true,
                    tickfont: {
                        size: 11
                    },
                    title: {
                        text: 'Number of Districts',
                        font: {
                            size: 12
                        }
                    }
                },
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    x: 0.5,
                    xanchor: 'center'
                },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: '#fff',
                    bordercolor: '#ddd',
                    font: {
                        size: 12
                    }
                },
                title: {
                    text: 'Trend of District Status Across Months',
                    font: {
                        size: 16,
                        color: '#333'
                    },
                    x: 0.5,
                    xanchor: 'center'
                }
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot(
                'statusTrendChart',
                [highTrace, mediumTrace, lowTrace],
                layout,
                config
            );
        }

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'Map') {
                initMap();
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 0);
            }
        }

        document.getElementById("defaultOpen").click();
    </script>
</body>
</html>