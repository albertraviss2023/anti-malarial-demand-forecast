<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MalariaShield - Uganda Malaria Dashboard</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    
    <style>
        :root {
            /* Color Scheme */
            --primary-color: #00BFA5;
            --primary-rgb: 0, 191, 165;
            --primary-dark: #008f7a;
            --primary-light: #a7ffeb;
            
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --info-color: #2196F3;
            
            /* Light Theme */
            --body-bg: #F4F7FC;
            --card-bg: #FFFFFF;
            --text-color: #475569;
            --heading-color: #1E293B;
            --border-color: #E2E8F0;
            --sidebar-bg: #1E293B;
            --sidebar-text: #CBD5E1;
            --sidebar-active-text: #FFFFFF;
            --sidebar-hover-bg: #334155;
            --sidebar-active-border: var(--primary-color);
            
            /* Shared Variables */
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
            --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem;
            --transition-speed: 0.3s;
        }

        [data-bs-theme="dark"] {
            /* Dark Theme */
            --body-bg: #131722;
            --card-bg: #1E293B;
            --text-color: #CBD5E1;
            --heading-color: #F8FAFC;
            --border-color: #334155;
            --sidebar-bg: #1E293B;
            --sidebar-text: #94A3B8;
            --sidebar-active-text: #FFFFFF;
            --sidebar-hover-bg: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        .dashboard-wrapper { display: flex; min-height: 100vh; }
        
        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0; left: 0; height: 100vh;
            transition: width var(--transition-speed) ease;
            z-index: 1030;
            border-right: 1px solid var(--border-color);
        }
        .sidebar-header {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 1.25rem 1.5rem;
            height: 65px;
            white-space: nowrap;
        }
        .sidebar-header .fa-shield-virus { font-size: 1.75rem; color: var(--primary-color); }
        .sidebar-title { font-size: 1.5rem; font-weight: 700; color: var(--sidebar-active-text); margin: 0; }
        .sidebar-nav { flex-grow: 1; padding: 1rem; }
        .sidebar-nav .nav-link {
            display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius); color: var(--sidebar-text); font-weight: 500;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            border-left: 3px solid transparent;
        }
        .sidebar-nav .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar-nav .nav-link.active {
            background-color: var(--sidebar-hover-bg);
            color: var(--sidebar-active-text);
            border-left-color: var(--sidebar-active-border);
        }
        .sidebar-nav .nav-link .fas { font-size: 1.1rem; width: 20px; text-align: center; }
        .sidebar-footer { padding: 1rem; border-top: 1px solid #334155; }
        .last-updated { font-size: 0.8rem; color: var(--sidebar-text); text-align: center; margin-top: 1rem; }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            margin-left: 260px;
            padding: 2rem;
            transition: margin-left var(--transition-speed) ease;
        }
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }
        #pageTitle { font-size: 1.75rem; font-weight: 700; color: var(--heading-color); }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        #sidebarToggle { color: var(--heading-color); }

        /* --- Cards & Charts --- */
        .dashboard-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            margin-bottom: 1.5rem;
            border-top: 3px solid transparent;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
        .card-body { padding: 1.5rem; }
        .card-title {
            font-weight: 600; font-size: 1.1rem;
            color: var(--heading-color); margin-bottom: 1rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .chart-container { min-height: 400px; width: 100%; }

        /* --- KPI Cards --- */
        .kpi-card {
            flex: 1; min-width: 200px; padding: 1.5rem;
            text-align: left;
            border-left: 4px solid var(--primary-color);
        }
        .kpi-label { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.25rem; }
        .kpi-value {
            font-size: 2.25rem; font-weight: 700;
            color: var(--heading-color);
        }
        .kpi-change {
            font-size: 0.85rem; margin-top: 0.5rem;
            display: flex; align-items: center; gap: 0.25rem;
        }
        .kpi-change.positive { color: var(--danger-color); }
        .kpi-change.negative { color: var(--success-color); }

        /* --- Map Styles --- */
        #map {
            height: 550px; width: 100%;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        /* Enhanced Map Markers */
        .district-marker {
            border-radius: 50%;
            transition: transform 0.2s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
        }
        
        .district-marker.high-risk {
            animation: high-glow 2s infinite alternate, flicker 0.3s infinite alternate;
        }
        
        .district-marker.medium-risk {
            animation: medium-glow 2s infinite alternate;
        }
        
        .district-marker.low-risk {
            animation: low-glow 2s infinite alternate;
        }
        
        @keyframes high-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(230, 55, 87, 0.7), 0 0 15px rgba(230, 55, 87, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(230, 55, 87, 0.9), 0 0 30px rgba(230, 55, 87, 0.9); }
        }
        
        @keyframes medium-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(246, 195, 67, 0.7), 0 0 15px rgba(246, 195, 67, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(246, 195, 67, 0.9), 0 0 30px rgba(246, 195, 67, 0.9); }
        }
        
        @keyframes low-glow {
            from { box-shadow: 0 0 5px #fff, 0 0 10px rgba(0, 217, 126, 0.7), 0 0 15px rgba(0, 217, 126, 0.7); }
            to { box-shadow: 0 0 10px #fff, 0 0 20px rgba(0, 217, 126, 0.9), 0 0 30px rgba(0, 217, 126, 0.9); }
        }
        
        @keyframes flicker {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        /* Enhanced Popups */
        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-lg);
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .leaflet-popup-content {
            margin: 0.75rem;
            font-family: 'Inter', sans-serif;
            min-width: 200px;
        }
        
        .leaflet-popup-content h5 {
            color: var(--heading-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .leaflet-popup-content .risk-meter {
            height: 6px;
            width: 100%;
            background: linear-gradient(to right, var(--success-color), var(--warning-color), var(--danger-color));
            border-radius: 3px;
            margin: 0.5rem 0;
        }
        
        /* Enhanced Legend */
        .leaflet-control.legend {
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .leaflet-control.legend h4 {
            margin: 0 0 0.5rem;
            color: var(--heading-color);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .leaflet-control.legend .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .leaflet-control.legend .legend-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        /* --- Tables --- */
        .table { --bs-table-bg: var(--card-bg); --bs-table-striped-bg: var(--body-bg); --bs-table-color: var(--text-color); --bs-table-border-color: var(--border-color); }
        .table-hover > tbody > tr { transition: background-color 0.2s; }
        .table-hover > tbody > tr:hover { background-color: rgba(var(--primary-rgb), 0.1); cursor: pointer; }
        .best-model { background-color: rgba(var(--primary-rgb), 0.15) !important; }
        .table thead th {
            background-color: var(--body-bg); color: var(--heading-color);
            font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px;
        }

        /* --- Status Indicators --- */
        .status-high { color: var(--danger-color); font-weight: 600; }
        .status-medium { color: var(--warning-color); font-weight: 600; }
        .status-low { color: var(--success-color); font-weight: 600; }

        /* --- Loading Spinner --- */
        .loading-spinner {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-spinner .spinner-border { width: 3rem; height: 3rem; color: var(--primary-color); }

        /* --- Responsive Design --- */
        @media (max-width: 992px) {
            .sidebar { width: 80px; }
            .sidebar-title, .sidebar-nav span, .sidebar-footer .btn span { display: none; }
            .sidebar-header, .nav-link { justify-content: center; }
            .main-content { margin-left: 80px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-shield-virus"></i>
                <h1 class="sidebar-title">MalariaShield</h1>
            </div>
            <nav class="sidebar-nav nav flex-column">
                <a href="#overview" class="nav-link active" data-bs-toggle="tab"><i class="fas fa-chart-pie"></i><span>Overview</span></a>
                <a href="#trends" class="nav-link" data-bs-toggle="tab"><i class="fas fa-chart-line"></i><span>Trends</span></a>
                <a href="#map-view" class="nav-link" data-bs-toggle="tab"><i class="fas fa-map-marked-alt"></i><span>Geospatial</span></a>
                <a href="#models" class="nav-link" data-bs-toggle="tab"><i class="fas fa-cogs"></i><span>Models</span></a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-outline-secondary w-100" id="themeToggle"><i class="fas fa-moon"></i> <span>Dark Mode</span></button>
                <div class="last-updated" id="lastUpdated"><i class="fas fa-clock"></i> <span>Loading...</span></div>
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            <header class="main-header">
                <h2 id="pageTitle">Uganda Malaria Surveillance</h2>
                <div class="header-actions">
                    <button class="btn btn-primary" id="refreshData"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                    <button class="btn btn-light" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                </div>
            </header>
            
            <div class="loading-spinner" id="loadingSpinner"><div class="spinner-border"></div></div>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4" data-aos="fade-up" data-aos-delay="100">
                           <div class="dashboard-card kpi-card">
                               <div class="kpi-label">Total Predicted Cases</div>
                               <div class="kpi-value" id="totalCasesKPI">-</div>
                               <div class="kpi-change" id="casesChangeKPI">May - Aug 2025</div>
                           </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4" data-aos="fade-up" data-aos-delay="200">
                           <div class="dashboard-card kpi-card">
                               <div class="kpi-label">High Risk Districts (Aug)</div>
                               <div class="kpi-value" id="highRiskKPI">-</div>
                               <div class="kpi-change" id="riskChangeKPI">vs May 2025</div>
                           </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4" data-aos="fade-up" data-aos-delay="300">
                           <div class="dashboard-card kpi-card">
                               <div class="kpi-label">Best Model (MAE)</div>
                               <div class="kpi-value" id="modelAccuracyKPI">-</div>
                               <div class="kpi-change" id="bestModelName">Loading...</div>
                           </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4" data-aos="fade-up" data-aos-delay="400">
                           <div class="dashboard-card kpi-card">
                               <div class="kpi-label">Climate Correlation</div>
                               <div class="kpi-value" id="climateCorrelationKPI">-</div>
                               <div class="kpi-change">Max Temp vs. Cases</div>
                           </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-7 mb-4">
                            <div class="dashboard-card h-100" data-aos="fade-up" data-aos-delay="500">
                                <div class="card-body">
                                    <h4 class="card-title"><i class="fas fa-map-marked-alt text-primary"></i> Top 5 High-Burden Districts</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="topDistrictsTable">
                                            <thead><tr><th>District</th><th>Total Cases</th><th>May</th><th>June</th><th>August</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 mb-4">
                            <div class="dashboard-card h-100" data-aos="fade-up" data-aos-delay="600">
                                <div class="card-body">
                                    <h4 class="card-title"><i class="fas fa-exclamation-triangle text-danger"></i> Key Insights</h4>
                                    <div id="keyInsightsContent"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="dashboard-card">
                        <div class="card-body">
                            <h3 class="card-title"><i class="fas fa-chart-line text-primary"></i> National Malaria & Climate Trends (2020-2025)</h3>
                            <p>Explore historical trends and correlations between total monthly malaria cases and key climate factors across Uganda.</p>
                             <div class="row">
                                <div class="col-lg-6"><div class="chart-container" id="malariaTrendChart"></div></div>
                                <div class="col-lg-6"><div class="chart-container" id="climateTrendChart"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-body">
                            <h3 class="card-title"><i class="fas fa-thermometer-half text-primary"></i> Climate Factor Correlation Plots</h3>
                             <div class="row">
                                <div class="col-lg-4 col-md-6"><div class="chart-container" id="corrTempMax"></div></div>
                                <div class="col-lg-4 col-md-6"><div class="chart-container" id="corrHumidity"></div></div>
                                <div class="col-lg-4 col-md-6"><div class="chart-container" id="corrPrecipitation"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="map-view" role="tabpanel">
                    <div class="dashboard-card">
                        <div class="card-body">
                            <h3 class="card-title"><i class="fas fa-map-marked-alt text-primary"></i> Geospatial Analysis of Predicted Risk</h3>
                            <p>Interactive map showing predicted malaria case status by district. Filter by month and risk level to identify high-priority areas.</p>
                            <div class="d-flex flex-wrap gap-3 mb-4">
                                <div>
                                    <label for="monthFilter" class="form-label fw-bold">Select Month</label>
                                    <select id="monthFilter" class="form-select">
                                        <option value="May">May 2025</option>
                                        <option value="June">June 2025</option>
                                        <option value="August" selected>August 2025</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="statusFilter" class="form-label fw-bold">Filter by Risk Level</label>
                                    <select id="statusFilter" class="form-select">
                                        <option value="all">All Districts</option>
                                        <option value="high">High Risk</option>
                                        <option value="medium">Medium Risk</option>
                                        <option value="low">Low Risk</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-8"><div id="map"></div></div>
                                <div class="col-lg-4"><div class="chart-container" id="statusTrendChart"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="models" role="tabpanel">
                     <div class="dashboard-card">
                        <div class="card-body">
                             <h3 class="card-title"><i class="fas fa-cogs text-primary"></i> Model Performance Metrics (MAE)</h3>
                            <p>Comparative analysis of predictive model performance using Mean Absolute Error (MAE). Lower MAE values indicate better predictive accuracy. The best-performing model is highlighted.</p>
                            <div class="row">
                                <div class="col-lg-7">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="metricsTable">
                                            <thead><tr><th>Model</th><th>MAE Sum</th><th>MAE</th><th>t+1 MAE</th><th>t+2 MAE</th><th>t+3 MAE</th></tr></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4" id="metricsAnalysisContent"></div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="chart-container" id="maeChart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- GLOBAL STATE & CONSTANTS ---
        const API_ENDPOINTS = {
            DISTRICTS: '/api/districts',
            MALARIA_PREDICTIONS: '/api/malaria_predictions',
            MODEL_METRICS: '/api/model_metrics',
            MALARIA_HISTORICAL: '/api/malaria_historical'
        };

        // Sample data for fallback when API fails
        const SAMPLE_DISTRICTS = [
            { district: "Kampala", latitude: 0.3136, longitude: 32.5811 },
            { district: "Wakiso", latitude: 0.4044, longitude: 32.4595 },
            { district: "Jinja", latitude: 0.4244, longitude: 33.2041 }
        ];

        const SAMPLE_PREDICTIONS = [
            { district: "Kampala", cases: { May: 12000, June: 11500, August: 13000 }, status: { May: "high", June: "high", August: "high" } },
            { district: "Wakiso", cases: { May: 8500, June: 9000, August: 9500 }, status: { May: "medium", June: "medium", August: "medium" } },
            { district: "Jinja", cases: { May: 4000, June: 4500, August: 5000 }, status: { May: "low", June: "low", August: "low" } }
        ];

        const SAMPLE_METRICS = [
            { model_name: "Prophet", mae_sum: 1250.45, mae: 300.25, "t+1_mae": 350.75, "t+2_mae": 400.15, "t+3_mae": 450.30 },
            { model_name: "ARIMA", mae_sum: 1450.60, mae: 350.40, "t+1_mae": 400.20, "t+2_mae": 450.50, "t+3_mae": 500.50 }
        ];

        const SAMPLE_HISTORICAL = {
            malaria_cases: [
                { date: "2020-01", cases: 12000 },
                { date: "2020-02", cases: 11500 }
            ],
            climate: [
                { date: "2020-01", avg_temp_max: 28.5, avg_humidity: 75, sum_precipitation: 120 },
                { date: "2020-02", avg_temp_max: 29.0, avg_humidity: 78, sum_precipitation: 150 }
            ],
            correlations: [
                { avg_temp_max: 28.5, mal_cases: 12000 },
                { avg_temp_max: 29.0, mal_cases: 11500 }
            ],
            correlation_coeffs: {
                avg_temp_max: 0.65,
                avg_humidity: 0.72,
                sum_precipitation: 0.58
            }
        };

        let state = {
            malariaData: [],
            modelMetrics: [],
            historicalData: null,
            currentMonth: 'August',
            isSidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true'
        };

        let map, districtsLayer, tileLayers, mapInfoControl, districtMarkers = {};
        
        // --- INITIALIZATION ---
        function initializeDashboard() {
            AOS.init({ duration: 800, once: true });
            initializeTheme();
            initializeSidebar();
            setupEventListeners();
            fetchData();
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function initializeSidebar() {
            if (state.isSidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('mainContent').classList.add('sidebar-collapsed');
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('refreshData').addEventListener('click', fetchData);
            document.getElementById('monthFilter').addEventListener('change', (e) => {
                state.currentMonth = e.target.value;
                updateMap();
            });
            document.getElementById('statusFilter').addEventListener('change', filterMarkers);
            
            document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (event) => {
                    const targetId = event.target.getAttribute('href').substring(1);
                    if (targetId === 'map-view' && !map) initMap();
                    window.dispatchEvent(new Event('resize')); 
                });
            });

            document.getElementById('topDistrictsTable').addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.districtId) {
                    highlightMapMarker(row.dataset.districtId);
                }
            });
        }
        
        // --- UI & THEME ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            updateUIForThemeChange();
        }

        function updateThemeIcon(theme) {
            const button = document.getElementById('themeToggle');
            const icon = button.querySelector('i');
            const text = button.querySelector('span');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            if(text) text.textContent = theme === 'dark' ? ' Light Mode' : ' Dark Mode';
        }

        function updateUIForThemeChange() {
            if (map && tileLayers) {
                const newTheme = document.documentElement.getAttribute('data-bs-theme');
                map.removeLayer(newTheme === 'dark' ? tileLayers.light : tileLayers.dark);
                map.addLayer(newTheme === 'dark' ? tileLayers.dark : tileLayers.light);
            }
            renderAllCharts();
        }

        function toggleSidebar() {
            state.isSidebarCollapsed = !state.isSidebarCollapsed;
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mainContent').classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', state.isSidebarCollapsed);
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
            document.getElementById('refreshData').disabled = show;
        }

        // --- DATA FETCHING & PROCESSING ---
        async function fetchData() {
            showLoading(true);
            try {
                const [districts, malaria, metrics, historical] = await Promise.all([
                    fetchWithFallback(API_ENDPOINTS.DISTRICTS, SAMPLE_DISTRICTS),
                    fetchWithFallback(API_ENDPOINTS.MALARIA_PREDICTIONS, SAMPLE_PREDICTIONS),
                    fetchWithFallback(API_ENDPOINTS.MODEL_METRICS, SAMPLE_METRICS),
                    fetchWithFallback(API_ENDPOINTS.MALARIA_HISTORICAL, SAMPLE_HISTORICAL)
                ]);

                // Process districts with malaria data
                state.malariaData = districts.map(district => {
                    const malariaDistrict = malaria.find(m => m.district.toLowerCase() === district.district.toLowerCase());
                    return {
                        ...district,
                        cases: malariaDistrict ? malariaDistrict.cases : { May: 0, June: 0, August: 0 },
                        status: malariaDistrict ? malariaDistrict.status : { May: 'low', June: 'low', August: 'low' }
                    };
                });
                
                state.modelMetrics = metrics;
                state.historicalData = historical;

                updateDashboard();

            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load dashboard data. Using sample data instead.');
                useSampleData();
            } finally {
                showLoading(false);
            }
        }

        async function fetchWithFallback(url, fallbackData) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch ${url}:`, error);
                return fallbackData;
            }
        }

        function useSampleData() {
            state.malariaData = SAMPLE_DISTRICTS.map(district => {
                const malariaDistrict = SAMPLE_PREDICTIONS.find(m => m.district === district.district);
                return {
                    ...district,
                    cases: malariaDistrict ? malariaDistrict.cases : { May: 0, June: 0, August: 0 },
                    status: malariaDistrict ? malariaDistrict.status : { May: 'low', June: 'low', August: 'low' }
                };
            });
            state.modelMetrics = SAMPLE_METRICS;
            state.historicalData = SAMPLE_HISTORICAL;
            updateDashboard();
        }

        function updateDashboard() {
            updateKPIs();
            renderOverviewContent();
            renderAllCharts();
            
            if (document.querySelector('#map-view').classList.contains('show')) {
                if (!map) initMap(); else updateMap();
            }
            updateLastUpdated();
            
            setTimeout(() => AOS.refresh(), 100);
        }

        // --- KPIs & OVERVIEW ---
        function animateCountUp(element, endValue, isLocale = true) {
            let startValue = 0;
            const duration = 1500;
            const stepTime = Math.abs(Math.floor(duration / endValue));
            
            const timer = setInterval(() => {
                startValue += Math.ceil(endValue / (duration / 10));
                if (startValue >= endValue) {
                    startValue = endValue;
                    clearInterval(timer);
                }
                element.textContent = isLocale ? Math.round(startValue).toLocaleString() : startValue.toFixed(2);
            }, 10);
        }

        function updateKPIs() {
            const totalCases = state.malariaData.reduce((sum, d) => sum + d.cases.May + d.cases.June + d.cases.August, 0);
            animateCountUp(document.getElementById('totalCasesKPI'), totalCases);

            const highRiskMay = state.malariaData.filter(d => d.status.May === 'high').length;
            const highRiskAug = state.malariaData.filter(d => d.status.August === 'high').length;
            const highRiskChange = highRiskMay > 0 ? ((highRiskAug - highRiskMay) / highRiskMay) * 100 : 0;
            
            animateCountUp(document.getElementById('highRiskKPI'), highRiskAug);
            const riskChangeElement = document.getElementById('riskChangeKPI');
            riskChangeElement.innerHTML = `<i class="fas fa-arrow-${highRiskChange >= 0 ? 'up' : 'down'}"></i> ${Math.abs(highRiskChange).toFixed(0)}%`;
            riskChangeElement.className = `kpi-change ${highRiskChange >= 0 ? 'positive' : 'negative'}`;

            if (state.modelMetrics.length) {
                const bestModel = state.modelMetrics.reduce((min, curr) => curr.mae_sum < min.mae_sum ? curr : min);
                animateCountUp(document.getElementById('modelAccuracyKPI'), bestModel.mae_sum, false);
                document.getElementById('bestModelName').textContent = bestModel.model_name;
            }

            if (state.historicalData && state.historicalData.correlation_coeffs) {
                animateCountUp(document.getElementById('climateCorrelationKPI'), state.historicalData.correlation_coeffs.avg_temp_max, false);
            }
        }

        function renderOverviewContent() {
            // Key Insights
            const highRiskAug = state.malariaData.filter(d => d.status.August === 'high').length;
            const highRiskMay = state.malariaData.filter(d => d.status.May === 'high').length;
            const consistentHigh = state.malariaData.filter(d => d.status.May === 'high' && d.status.June === 'high' && d.status.August === 'high');
            document.getElementById('keyInsightsContent').innerHTML = `
                <p>Predictions indicate <strong>${highRiskAug}</strong> districts will be at <span class="status-high">High-risk</span> in August 2025, compared to <strong>${highRiskMay}</strong> in May.</p>
                <p><strong>${consistentHigh.length} districts</strong> remain consistently at high risk throughout the forecast period: ${consistentHigh.length > 0 ? consistentHigh.map(d => d.district).slice(0, 3).join(', ') + (consistentHigh.length > 3 ? '...' : '') : 'None'}.</p>
            `;

            // Top Districts Table
            const districtsWithTotals = state.malariaData.map(d => ({
                district: d.district,
                totalCases: d.cases.May + d.cases.June + d.cases.August,
                status: d.status
            })).sort((a, b) => b.totalCases - a.totalCases).slice(0, 5);
            
            const tbody = document.querySelector('#topDistrictsTable tbody');
            tbody.innerHTML = districtsWithTotals.map(d => `
                <tr data-district-id="${d.district}">
                    <td><strong>${d.district}</strong></td>
                    <td>${Math.round(d.totalCases).toLocaleString()}</td>
                    <td><span class="status-${d.status.May}">●</span></td>
                    <td><span class="status-${d.status.June}">●</span></td>
                    <td><span class="status-${d.status.August}">●</span></td>
                </tr>
            `).join('');
        }

        // --- MAP ---
        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([1.3733, 32.2903], 7);
            L.control.zoom({ position: 'topright' }).addTo(map);

            tileLayers = {
                light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                })
            };
            
            (document.documentElement.getAttribute('data-bs-theme') === 'dark' ? tileLayers.dark : tileLayers.light).addTo(map);
            districtsLayer = L.layerGroup().addTo(map);
            
            // Enhanced Legend
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Malaria Risk Status</h4>
                    <div class="legend-item">
                        <div class="legend-icon" style="background:var(--danger-color);"></div>
                        <span>High Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background:var(--warning-color);"></div>
                        <span>Medium Risk</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background:var(--success-color);"></div>
                        <span>Low Risk</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);

            updateMap();
        }

        function updateMap() {
            if (!districtsLayer) return;
            districtsLayer.clearLayers();
            districtMarkers = {};
            const theme = document.documentElement.getAttribute('data-bs-theme');

            function getStatusColor(status) {
                if (status === 'high') return getComputedStyle(document.body).getPropertyValue('--danger-color');
                if (status === 'medium') return getComputedStyle(document.body).getPropertyValue('--warning-color');
                return getComputedStyle(document.body).getPropertyValue('--success-color');
            }

            function getStatusClass(status) {
                if (status === 'high') return 'high-risk';
                if (status === 'medium') return 'medium-risk';
                return 'low-risk';
            }

            state.malariaData.forEach(data => {
                const currentStatus = data.status[state.currentMonth] || 'low';
                const color = getStatusColor(currentStatus);
                const statusClass = getStatusClass(currentStatus);
                const cases = data.cases[state.currentMonth];
                const percentage = Math.min(100, Math.max(0, (cases / 10000) * 100));

                const icon = L.divIcon({
                    className: `district-marker ${statusClass}`,
                    html: `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border: 2px solid ${theme === 'dark' ? '#1E293B' : '#FFFFFF'};"></div>`,
                    iconSize: [20, 20], 
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([data.latitude, data.longitude], { 
                    icon: icon, 
                    data: data, 
                    riseOnHover: true 
                });

                marker.bindPopup(`
                    <h5>${data.district}</h5>
                    <div class="d-flex justify-content-between">
                        <div><strong>Predicted Cases:</strong></div>
                        <div>${Math.round(cases).toLocaleString()}</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div><strong>Risk Level:</strong></div>
                        <div class="status-${currentStatus}">${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)}</div>
                    </div>
                    <div class="risk-meter" style="background-position: ${percentage}% 0;"></div>
                    <small>Data for ${state.currentMonth} 2025</small>
                `);

                marker.on('mouseover', function() {
                    this.openPopup();
                    this.getElement().style.transform = 'scale(1.5)';
                });

                marker.on('mouseout', function() {
                    this.getElement().style.transform = 'scale(1)';
                });

                marker.addTo(districtsLayer);
                districtMarkers[data.district] = marker;
            });
            filterMarkers();
            renderStatusTrendChart();
        }

        function filterMarkers() {
            const filterValue = document.getElementById('statusFilter').value;
            districtsLayer.eachLayer(layer => {
                const currentStatus = layer.options.data.status[state.currentMonth];
                if (filterValue === 'all' || currentStatus === filterValue) {
                    layer.getElement().style.display = 'block';
                } else {
                    layer.getElement().style.display = 'none';
                }
            });
        }
        
        function highlightMapMarker(districtName) {
            document.querySelector('a[href="#map-view"]').click();
            const marker = districtMarkers[districtName];
            if (marker) {
                map.flyTo(marker.getLatLng(), 10);
                marker.openPopup();
                marker.getElement().classList.add('marker-highlight');
                setTimeout(() => {
                    marker.getElement().classList.remove('marker-highlight');
                }, 3000);
            }
        }
        
        // --- CHARTS ---
        function getPlotlyLayout(title) {
            const theme = document.documentElement.getAttribute('data-bs-theme');
            return {
                title: { text: title, font: { color: getComputedStyle(document.body).getPropertyValue('--heading-color'), size: 16 } },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                margin: { l: 60, r: 30, b: 50, t: 60, pad: 4 },
                font: { color: getComputedStyle(document.body).getPropertyValue('--text-color'), family: 'Inter, sans-serif' },
                xaxis: { gridcolor: getComputedStyle(document.body).getPropertyValue('--border-color') },
                yaxis: { gridcolor: getComputedStyle(document.body).getPropertyValue('--border-color') },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center' }
            };
        }

        function renderAllCharts() {
            if (!state.historicalData) return;
            renderMalariaTrendChart();
            renderClimateTrendsChart();
            renderCorrelationPlots();
            renderStatusTrendChart();
            renderModelMetrics();
        }

        function renderMalariaTrendChart() {
            const trace = {
                x: state.historicalData.malaria_cases.map(d => d.date),
                y: state.historicalData.malaria_cases.map(d => d.cases),
                mode: 'lines',
                line: { color: getComputedStyle(document.body).getPropertyValue('--primary-color'), width: 3, shape: 'spline' },
                fill: 'tozeroy',
                fillcolor: `rgba(${getComputedStyle(document.body).getPropertyValue('--primary-rgb')}, 0.1)`
            };
            const layout = getPlotlyLayout('Monthly Malaria Cases (National Total)');
            Plotly.newPlot('malariaTrendChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function renderClimateTrendsChart() {
            const traces = [{
                x: state.historicalData.climate.map(d => d.date),
                y: state.historicalData.climate.map(d => d.avg_temp_max),
                name: 'Max Temp',
                mode: 'lines',
                line: { color: getComputedStyle(document.body).getPropertyValue('--danger-color'), width: 2, shape: 'spline' }
            }, {
                x: state.historicalData.climate.map(d => d.date),
                y: state.historicalData.climate.map(d => d.avg_humidity),
                name: 'Humidity',
                mode: 'lines',
                line: { color: getComputedStyle(document.body).getPropertyValue('--info-color'), width: 2, shape: 'spline' },
                yaxis: 'y2'
            }];
            const layout = getPlotlyLayout('Climate Factors vs. Time');
            layout.yaxis = { title: 'Temp (°C)', gridcolor: getComputedStyle(document.body).getPropertyValue('--border-color') };
            layout.yaxis2 = { title: 'Humidity (%)', overlaying: 'y', side: 'right', showgrid: false };
            Plotly.newPlot('climateTrendChart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        function renderCorrelationPlots() {
            const factors = [
                { key: 'avg_temp_max', label: 'Max Temp', div: 'corrTempMax', color: getComputedStyle(document.body).getPropertyValue('--danger-color') },
                { key: 'avg_humidity', label: 'Humidity', div: 'corrHumidity', color: getComputedStyle(document.body).getPropertyValue('--info-color') },
                { key: 'sum_precipitation', label: 'Precipitation', div: 'corrPrecipitation', color: getComputedStyle(document.body).getPropertyValue('--primary-color') }
            ];

            factors.forEach(factor => {
                const trace = {
                    x: state.historicalData.correlations.map(d => d[factor.key]),
                    y: state.historicalData.correlations.map(d => d.mal_cases),
                    mode: 'markers', marker: { size: 6, color: factor.color, opacity: 0.7 }
                };
                const corr = state.historicalData.correlation_coeffs[factor.key];
                const layout = getPlotlyLayout(`${factor.label} vs. Cases (r=${corr.toFixed(2)})`);
                layout.xaxis.title = factor.label;
                layout.yaxis.title = 'Malaria Cases';
                Plotly.newPlot(factor.div, [trace], layout, { responsive: true, displayModeBar: false });
            });
        }
        
        function renderStatusTrendChart() {
            const months = ['May', 'June', 'August'];
            const counts = {
                high: months.map(m => state.malariaData.filter(d => d.status[m] === 'high').length),
                medium: months.map(m => state.malariaData.filter(d => d.status[m] === 'medium').length),
                low: months.map(m => state.malariaData.filter(d => d.status[m] === 'low').length)
            };
            const traces = [{
                x: months, y: counts.high, name: 'High', type: 'bar', marker: { color: getComputedStyle(document.body).getPropertyValue('--danger-color') }
            }, {
                x: months, y: counts.medium, name: 'Medium', type: 'bar', marker: { color: getComputedStyle(document.body).getPropertyValue('--warning-color') }
            }, {
                x: months, y: counts.low, name: 'Low', type: 'bar', marker: { color: getComputedStyle(document.body).getPropertyValue('--success-color') }
            }];
            const layout = getPlotlyLayout('District Risk Level Counts');
            layout.barmode = 'stack';
            layout.yaxis.title = '# of Districts';
            Plotly.newPlot('statusTrendChart', traces, layout, { responsive: true, displayModeBar: false });
        }

        function renderModelMetrics() {
            if (!state.modelMetrics.length) return;
            const bestModel = state.modelMetrics.reduce((min, curr) => curr.mae_sum < min.mae_sum ? curr : min);
            const tbody = document.querySelector('#metricsTable tbody');
            tbody.innerHTML = state.modelMetrics.map(model => `
                <tr class="${model.model_name === bestModel.model_name ? 'best-model' : ''}">
                    <td>${model.model_name}</td>
                    <td>${model.mae_sum.toFixed(2)}</td>
                    <td>${model.mae.toFixed(2)}</td>
                    <td>${model['t+1_mae'].toFixed(2)}</td>
                    <td>${model['t+2_mae'].toFixed(2)}</td>
                    <td>${model['t+3_mae'].toFixed(2)}</td>
                </tr>
            `).join('');
            
            const trace = {
                x: state.modelMetrics.map(m => m.mae_sum),
                y: state.modelMetrics.map(m => m.model_name),
                type: 'bar', orientation: 'h',
                marker: { color: state.modelMetrics.map(m => m.model_name === bestModel.model_name ? getComputedStyle(document.body).getPropertyValue('--primary-color') : '#94a3b8') }
            };
            const layout = getPlotlyLayout('Model MAE Sum Comparison');
            layout.xaxis.title = 'MAE Sum (Lower is Better)';
            Plotly.newPlot('maeChart', [trace], layout, { responsive: true, displayModeBar: false });

            document.getElementById('metricsAnalysisContent').innerHTML = `
                <p>The <strong>${bestModel.model_name}</strong> model demonstrates the highest accuracy with the lowest overall MAE Sum of <strong>${bestModel.mae_sum.toFixed(2)}</strong>. This model's predictions are used throughout the dashboard.</p>
            `;
        }

        function updateLastUpdated() {
            const now = luxon.DateTime.now().setZone('Africa/Kampala');
            document.getElementById('lastUpdated').querySelector('span').textContent = `Updated: ${now.toFormat('MMM dd, HH:mm')}`;
        }
        
        // --- START THE APP ---
        initializeDashboard();
    });
    </script>
</body>
</html>